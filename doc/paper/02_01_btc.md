## *Bitcoin*
\label{n2:btc}

É considerado o início do *Bitcoin* a publicação do *whitepaper* técnico de Satoshi Nakamoto, onde foram dissertados algumas características comercialmente atrativas, o funcionamento de aspectos chaves da tecnologia e algumas análises estatísticas de risco sobre a organização dos computadores na rede.

A concepção do *Bitcoin* possibilitou a existência de uma moeda privada que, até então, eram facilmente suspensas de circulação por autoridades legais. Tal foi o caso da *Liberty Dollar*, uma moeda privada que, segundo \citeonline{dollar}, teve o seu criador formalmente acusado de conspiração e terrorismo pelo fato de competir com o banco central na criação e gerenciamento de uma moeda. Esta percepção demandou a busca por uma maior resistência pelas moedas descentralizadas, e isso implica na ausência de uma autoridade central, obrigando a rede a manter coerência sobre o estado dos saldos de todos usuários, considerados por cada usuário, de uma forma descentralizada. 

O termo *Bitcoin* é recente e está em processo de compreensão. Segundo \citeonline[p.~15]{Ulrich}, "... o Bitcoin é uma forma de dinheiro, assim como o real, o dólar ou o euro, com a diferença de ser puramente digital e não ser emitido por nenhum governo". Ele ainda acrescenta que "Com o Bitcoin você pode transferir fundos de A para B em qualquer parte do mundo sem jamais precisar confiar em um terceiro para essa simples tarefa".

De forma simplificada, o *Bitcoin* tem uma *blockchain* que representa um histórico imutável das transferências efetuadas no passado, e também uma acumulação de *Proof of Work* realizada na validação de cada bloco. Como uma pilha que pode apenas receber novos elementos, novas informações não alteram informações passadas. Cada participante tem a liberdade de alterar ou ignorar as informações da *blockchain* do seu próprio ponto de vista (em seu próprio disco-rígido), mas caso queira que outros nodos da rede não o ignore e façam determinadas alterações sobre suas próprias *blockchains* (em seus próprios disco-rígidos), deverá seguir e se comunicar conforme as regras do sistema.

Antes de se definir o que é o *Bitcoin*, é recomendado seguir o padrão existente na literatura utilizada, onde o *Bitcoin* é dividido em duas perspectivas: seu funcionamento como uma tecnologia que oferece uma forma de pagamento formada por uma rede de computadores; e uma moeda digital. Tal diferenciação é dada na escrita da palavra *bitcoin*, onde o nome próprio *Bitcoin* representa a primeira perspectiva, e o nome em caixa baixa *bitcoin* representa a segunda perspectiva. Ainda como uma moeda digital, uma quantidade de *bitcoins* pode ter sua unidade representada por BTC.

Um aspecto para se compreender do *Bitcoin* é o seu contraste com outras formas de dinheiro, como foi feito por \citeonline{bis}, que delineou certas características que podem existir em comum entre diversas formas de dinheiro: ser de responsabilidade de alguém, ser *Peer-to-Peer* e ser eletrônico. As formas de dinheiro comparadas foram as *commodities* (como moedas de ouro), os papéis-moeda (como as notas de Real), os depósitos bancários (como Real em Conta-Corrente) e as criptomoedas (como o *Bitcoin*). O contraste pela primeira característica, de ser de responsabilidade de alguém, separa as *commodities* e as criptomoedas dos papéis-moeda e dos depósitos bancários, pois os últimos são de responsabilidade dos bancos centrais. O contraste pela segunda característica, de ser *Peer-to-Peer*, separa as *commodities*, as criptomoedas e os papéis-moeda dos depósitos bancários, pois apenas este último requer autorização de uma autoridade central na transferência de posse ou título de dinheiro. O contraste pela terceira característica, de ser eletrônico, separa as *commodities* e os papéis-moeda dos depósitos bancários e criptomoedas, pois apenas estes últimos existem eletronicamente.

Para \citeonline{Antonopoulos}, o *Bitcoin*, é um conjunto de conceitos e tecnologias que formam a base de um ecossistema de dinheiro digital. Sendo assim, para a compreensão da tecnologia e seu funcionamento, é necessário saber e compreender quais são os estes conceitos e tecnologias.

### Transação
\label{n3:tx}

Um dos conceitos fundamentais para qualquer dinheiro e também para o *Bitcoin* é a ideia de transferência ou transação.
> Cada proprietário transfere a moeda para o próximo, assinando digitalmente um hash das transações anteriores e a chave pública do próximo proprietário e as adicionando ao fim da moeda. Um beneficiário pode conferir as assinaturas para verificar a cadeia de propriedade. \cite[p.~2]{satoshi}

Como nesta definição inicial existem alguns termos que são técnicos, vale a pena entender a explicação a seguir:
> Em termos simples, uma transação informa para a rede que o dono de uma quantidade de bitcoins autorizou a transferência de alguns destes bitcoins para outro dono. O novo dono agora pode gastar esses bitcoins ao criar uma nova transação que autoriza a transferência para um outro dono, e assim por diante, em uma cadeia de posse de bitcoins. \cite[cap. Transações Bitcoin p.~4]{Antonopoulos}.

Após o entendimento da definição inicial de transação, é possível entender uma função peculiar e primordial para o *Bitcoin*: o encadeamento de transações. Cada transação define alguns dos critérios que serão avaliados sobre qualquer transação imediatamente posterior (que faz referência à anterior). Cada transação posterior tem a função de provar posse sobre os *bitcoins* que pretende-se gastar. 

Para \citeonline{peck}, cada moeda gasta--atrelada a uma transação--está associada a uma chave pública. E a chave privada desta chave pública deve ser utilizada na assinatura digital de uma transação posterior. Esta última transação, também, deve associar uma nova--para ser utilizada posteriormente--chave pública.

%#### Criptografia
\label{n4:cripto}

Os termos utilizados por \citeonline{peck} e \citeonline{satoshi}, de assinatura digital e de chaves públicas e privadas, são termos utilizados na criptografia. \citeonline{Antonopoulos} explica didaticamente que as chaves públicas e privadas são números inteiros com algumas relações matemáticas entre eles. Uma relação importante é que da chave privada, gera-se a chave pública, dada uma função de curva elíptica apropriada--curva que é a mesma utilizada por todos os usuários do *Bitcoin*. A chave pública é utilizada principalmente para se receber *bitcoins*, e a chave privada, para gastar os *bitcoins* recebidos para a sua chave pública, pois existe uma relação matemática entre ambas as chaves, no qual uma informação assinada digitalmente com uma chave privada pode ser verificada pela chave pública.

### *Blockchain* e Mineração
\label{n3:block_mine}

Segundo \citeonline{scorex}, as inovações utilizadas por Sakamoto foram as que resultaram em uma dinâmica de consenso emergente: da confiança da imutabilidade do histórico que aumenta exponencialmente sobre o período de existência do dado em questão; das alterações do estado da rede por mudanças incrementais representadas por estruturas atômicas; e a exclusão do encadeamentos alternativos de mudanças regido pela prova de trabalho total representada por cada encadeamento excludentes entre si. Tais inovações envolvem os blocos, cada um constituído de um *header* e de de *payload*, e uma cadeia dos *headers* destes blocos. Cada bloco representa um incremento de informações na *blockchain*, de forma que novos nodos, aqueles fora de sincronia, podem atingir coerência com o restante da rede apenas pelos blocos posteriores ao último bloco comum.

\citeonline{peck} define a *Blockchain* como um livro-razão digital universalmente acessível, estruturado de tal forma que as alterações acontecem por adição de novas informações no final da cadeia de blocos, sendo cada adição um novo bloco, contendo informações como um conjunto de novas transações e uma referência para o bloco anterior.

Estruturalmente, cada bloco contém um *header* e possivelmente um *payload*. Conforme foi postulado:

> Cada bloco contido na blockchain é identificado no cabeçalho do bloco por um hash, que é gerado utilizando-se o algoritmo criptográfico de hash SHA256. Cada bloco também contém uma referência ao bloco anterior, conhecido como o bloco pai, através do campo "hash do bloco anterior (previous block hash)" que existe no cabeçalho do bloco. Em outras palavras, cada bloco contém o hash de seu bloco pai no interior de seu próprio cabeçalho. A sequência de hashes ligando cada bloco ao seus pai cria uma corrente que pode ser seguida retrogradamente até o primeiro bloco que já foi criado, que é conhecido como o bloco gênese. \cite[cap. A Blockchain p.~1]{Antonopoulos}

O *payload* de cada bloco adiciona transações à *blockchain*, que podem alterar os saldos dos usuários. É neste *payload* que a ordem das transações são definidas. Existindo a ordem de todas as transações, o gasto duplo--um caso problemático de quando participantes lidam com informações divergentes acerca dos seus saldos--é impossibilitado.

Um problema pertinente para um sistema que valida ou invalida transações sem uma autoridade central é evitar o gasto duplo, que, segundo \citeonline{satoshi}, ocorre quando não há um acordo sobre um histórico único entre todos os participantes e quando não há uma concordância em relação à ordem de todas as transações. Segundo ele, isto é resolvido quando cada transação é atrelada a um *timestamp* de um bloco. Nakamoto se inspirou em um sistema apresentado por Adam Back para implementar um servidor *timestamp* distribuído. Para isso, ele utilizou o conceito de *Proof-of-Work*, no qual aqueles que competem para adicionar novos blocos na *blockchain* conseguem provar que, na média, muitos ciclos de CPU foram gastos para esta tarefa.

É possível considerar o gasto duplo como um caso especial de *data-race*. Todo saldo que alguém tem em *bitcoin* depende do histórico em que este saldo se baseia, interpretado da *blockchain*. Todos os saldos remetem a um caminho de transferências dada por transações que existe até a criação de cada unidade de *bitcoin* (nas transações de *coinbase*), e também remetem, através do encadeamento dos *headers* dos blocos, ao bloco gênese, uma informação de estado inicial e fixa em todos os nodos de *Bitcoin*. Portanto o saldo não existe apenas pela última transação referente a este saldo na *blockchain*, mas à todo um encadeamento de transações. Imaginando que uma transação antiga desapareça, todas as transações que dependem daquela também desapareceriam devido à natureza do encadeamento de transferências do *Bitcoin*. Neste setido, toda nova transferência é uma reafirmação da existência deste histórico de transações mais antigas no qual aquela nova transação se sustenta, e é uma afirmação de que este histórico persistirá (de que novas transações futuras poderão se basear nesta última). Esta organização estrutural delimita a possibilidade de *data-race* (e do gasto-duplo): quando alguma informação histórica é alterada.

A imutabilidade do histórico, que garante a verificação independente por cada nodo sobre cada transação e cada bloco passado, sendo isto uma função indispensável para um sistema descentralizado, é explanada por \citeonline{scorex}: O *header* de cada bloco tem uma referência válida para o *header* do bloco antecedente, uma referência válida às transações contidas no *payload* do bloco (chamado de *markle root*), e um número que é considerado, em conjunto com o próprio *header*, prova válida de dispêndio de esforço na criação do próprio bloco. Uma referência/prova perde a validade quando o que é referenciado/provado é alterado. Com este esquema, uma alteração em qualquer dado existente em um bloco antigo resultaria na invalidade da prova de esforço do bloco questão, e também na invalidade de toda a cadeia de *headers* posteriores àquele bloco. É então possível considerar dois estados distintos de cadeia de blocos: aquele inerte, antes da alteração sobre o dado antigo, e um alternativo, que inclui a alteração sobre o dado antigo. Este estado alternativo da cadeia de blocos não seria descartado pelos participantes da rede apenas se a somatória de dificuldade da prova de esforço contida nos blocos fosse maior do que no estado anterior (antes da tentativa de mudança sobre um dado antigo), o que só seria possível se o autor da alteração somasse à prova de esforço total do estado alternativo se re-criasse blocos posteriores à mudança, um feito mais custoso à medida da antiguidade do bloco alterado.

A prova de trabalho não só tem uso na escolha dentre cadeias válidas e reforçar a imutabilidade de acordo com a antiguidade, mas também para, em certo grau, garantir a discretização temporal da criação de blocos válidos pela rede como um todo. Isso tem utilidade para o controle da quantidade de informações que são inseridas no sistema e da quantidade de unidades monetárias que são criadas. Além disto, tal discretização simplifica a distribuição da escolha daquela entidade que, em um dado momento, define quais informações serão adicionadas no sistema--entidade chamada de *leader* por \citeonline{scorex}--uma vez que diminui as chances da existência de duas destas entidades em simultâneo.

A criação de blocos é chamada de mineração e o entendimento mais difundido reflete na explicação dada por \citeonline{Antonopoulos}, no qual a mineração é um processo onde nodos na rede competem entre si para criarem novos blocos ao utilizarem hardware especializado para resolver os algoritmos de *Proof-of-Work*, gravando a solução encontrada no bloco gerado e assim provando o esforço do próprio nodo. Como apenas o nodo ganhador pode adicionar o bloco na *blockchain* e o mesmo consegue provar o trabalho que realizou para fazer esta inserção, a mineração garante a segurança do sistema *bitcoin* e permite a existência de um consenso em toda a rede sem a necessidade de uma autoridade central, uma vez que este bloco recém-criado é transmitido e aceito para e pelos outros nodos da rede.

### Protocolo e Nodos
\label{n3:proto_node}

Segundo \citeonline{btcref}, a rede padrão do *Bitcoin* se comunica pelo protocolo de rede P2P do *Bitcoin*. Tal comunicação acontece entre nodos via TCP, e contém dados que representam troca de mensagens, estas, com *header* de tamanho fixo e possivelmente com *payload*.
Existem algumas constantes nos *headers*: *command*, *magic bytes*, *payload len* e *payload checksum* que servem para especificar a rede a ser utilizada, como a *Mainet* e *Testnet*, especificar o tipo da mensagem, tamanho em *bytes* do *payload* e o seu *checksum*, respectivamente.
A versão do protocolo e os *bitflags* de *services* são informados na mensagem de *Version* e a troca desta mensagem representa o *handshake* entre dois *peers* no protocolo. A versão do procolo é importante para que um *peer* informe aos outros a sua capacidade comunicativa. Os *services* informa aos outros os serviços que aquele *peer* está disposto a fazer.

Outro conceito essencial para a o entendimento de *bitcoin* são os nodos que fazem parte da rede P2P do *Bitcoin*. Existem diversas funcionalidades para um nodo e cada nodo pode exercer um combinado destas funcionalidades. Segundo \citeonline{Antonopoulos}, são quatro os principais tipos funções: carteira, mineração, *blockchain* completa e nodo de roteamento. Onde os nodos de Cliente SPV, Nodo de Mineração e o Nodo Completo tem a função de roteamento segundo o protocolo P2P da rede do *Bitcoin*. Com a exceção do nodo de Cliente SPV, todos os nodos também mantém uma cópia local da *blockchain*, que pode ser utilizada para a verificação local de todas as transações. O Nodo de Mineração faz parte do grupo de mineradores. O Cliente SPV oferece uma carteira ao usuário, uma interface que gerencia as chaves privadas e facilita a criação das mensagens de envio de transações.

O Nodo de Referência implementa todas as quatro funções e é chamado de *Bitcoin Core*, implementado na linguagem de programação C++. Embora possam existir diversas implementações de nodos que preencham estas funções, é possível verificar em sites online, como em \citeonline{bitnodes}, que a grande maioria dos nodos funcionais na rede P2P do *Bitcoin* são variações do *Bitcoin Core*--aqueles com o campo *User Agent* com o valor de "Satoshi".

Segundo \citeonline{newbery} este nodo não possui um desempenho satisfatório mesmo em um ambiente com muitos *cores* de processamento, pois mesmo que o programa seja executando com múltiplas *threads*, muitas funções utilizam do recurso de *lock* global, bloqueando outras *threads* até a liberação do recurso. Ele ainda complementa que seria necessário reduzir a quantidade de chamadas globais para poder executar tarefas de carteira, validação de blocos e servir montar blocos e transações si. 

Uma alternativa ao uso corrente de *lock* global está sendo desenvolvido e é possível visualizar o seu avanço através de \citeonline{pull} do *Bitcoin Core*. Este *pull* faz parte de um projeto maior de adaptar o nodo de referência para trabalhar com o modelo IPC (*Inter Process Communication*). Esta mudança está em desenvolvimento desde março de 2017.
